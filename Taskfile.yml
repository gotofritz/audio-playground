version: "3"

vars:
  ALL: . tests/
  VENV: $CONDA_PREFIX/bin
  SOURCES: ./

tasks:
  lint-fix:
    desc: "Fix linting issues"
    cmds:
      - "{{.VENV}}/ruff check --fix {{.SOURCES}}"
      - "{{.VENV}}/ruff format {{.SOURCES}}"

  ruff:
    desc: "Run ruff"
    cmds:
      - "{{.VENV}}/ruff check {{.SOURCES}}"
      - "{{.VENV}}/ruff format {{.SOURCES}}"

  # Task to open the latest coverage report in a web browser
  coverage:
    desc: "Open the latest coverage report in a web browser"
    cmds:
      - open tests/coverage/index.html

  # Task to run all linting tasks (ruff, ty)
  lint:
    desc: "Run all linting tasks"
    deps:
      - ruff
      - ty

  # Task to run ty for static type checking on the source code
  ty:
    desc: "Run ty for static type checking"
    cmds:
      - "{{.VENV}}/ty check src"

  # Task to run linting and tests
  qa:
    desc: "Run linting and tests"
    deps:
      - test
      - lint

  # Task to run tests using pytest with coverage reporting
  test:
    desc: "Run tests with coverage"
    cmds:
      - pytest -vv -s --cov --cov-report=html:tests/coverage --cov-fail-under=40 $(if [ -n "{{.CLI_ARGS}}" ]; then echo "{{.CLI_ARGS}}"; else echo .; fi)
